<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chimara Director - Secure</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <header class="site-header">
  <img src="img/HPSC.jpeg" alt="Hero Public Safety Commission emblem" class="emblem" />
      <div>
        <div class="site-title">Hero Public Safety Commission</div>
        <div class="site-sub">Chimara — Director Access</div>
      </div>
    </header>

    <main class="container">
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="protected.html">Projects</a>
        <a href="chimara.html">Chimara</a>
      </nav>

      <section class="card" style="margin-top:18px">
        <h2 style="margin-top:0; font-family:Merriweather, serif; color:var(--brand-navy)">Chimara — Director Portal</h2>
        <p class="muted">Confidential director materials. Access is restricted to the Chimara Director.</p>

        <div id="secretContent" style="margin-top:12px">Checking director access…</div>

        <p style="margin-top:14px">
          <button id="chimaraLogout" class="btn btn-secondary">Sign out of Chimara</button>
        </p>
      </section>

      <footer class="site-footer">© <span id="year"></span> Hero Public Safety Commission</footer>
    </main>

    <script src="js/auth.js"></script>
    <script>
      // Must be logged-in (global Auth) and have Chimara director access
      document.getElementById('year').textContent = new Date().getFullYear();
      Auth.requireAuth('login.html');

      function hasChimaraAccess(){
        try {
          const s = JSON.parse(localStorage.getItem('chimara_access'));
          return s && s.username && s.username.toLowerCase() === 'red';
        } catch(e){ return false; }
      }

      if (!hasChimaraAccess()){
        // redirect back to chimara login page
        location.href = 'chimara.html';
      } else {
        const content = document.getElementById('secretContent');
        // render director materials plus a long subjects list (Subject #1 - Subject #2600)
        content.innerHTML = `
          <p>Welcome, Director <strong>Red</strong>. Below are the restricted Chimara subject materials.</p>

          <div style="margin-top:16px">
            <div style="margin-bottom:12px">
              <a href="classifications.html" class="btn btn-secondary" style="text-decoration:none; display:inline-block; padding:8px 12px; border-radius:6px">Classifications</a>
            </div>
            <h3 style="margin:0 0 8px 0">Subjects (People)</h3>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
              <input id="subjectSearch" type="search" placeholder="Search by number (e.g. 42) or text" style="flex:1; min-width:220px; padding:8px; border-radius:6px; border:1px solid #d1d5db" />
              <input id="subjectJump" type="number" min="1" max="2600" placeholder="Go to #" style="width:110px; padding:8px; border-radius:6px; border:1px solid #d1d5db" />
              <button id="subjectGo" class="btn btn-primary">Go</button>
              <button id="subjectClear" class="btn btn-secondary">Clear</button>
            </div>

            <div id="subjectsCount" class="muted" style="margin-bottom:8px">Preparing list…</div>
            <div id="subjectsContainer" style="max-height:520px; overflow:auto; border:1px solid #eef2ff; padding:10px; border-radius:6px; background:white; position:relative"></div>
          </div>
        `;

        // now render the 2600 subjects in chunks to avoid freezing
        const container = document.getElementById('subjectsContainer');
        const countEl = document.getElementById('subjectsCount');
        const searchEl = document.getElementById('subjectSearch');
        const jumpEl = document.getElementById('subjectJump');
        const goBtn = document.getElementById('subjectGo');
        const clearBtn = document.getElementById('subjectClear');

        const TOTAL = 2600;

        // create an array of subjects with names (when known)
        function makeSubject(i){
          const names = {
            1092: 'Maxus Blackwood',
            1128: 'Olivia Foster',
            1396: '"Amir"',
            1751: 'Moon',
            1753: 'Saburo',
            1755: 'Xanti',
            2008: 'Violet',
            2012: 'Solar',
            2037: 'Michi',
            2099: 'Mia'
          };
          if (names[i]) {
            return { id: i, name: `Subject #${i} - ${names[i]}`, note: '' };
          }
          return { id: i, name: `Subject #${i}`, note: '' };
        }

        // filter by query (number or text)
        function matches(subject, q){
          if (!q) return true;
          q = q.trim().toLowerCase();
          if (!q) return true;
          // numeric query
          if (/^\d+$/.test(q)){
            return String(subject.id) === q;
          }
          return subject.name.toLowerCase().indexOf(q) !== -1 || (subject.note && subject.note.toLowerCase().indexOf(q) !== -1);
        }

        // list of subject IDs that should link to dedicated pages
        const CLICKABLE_IDS = new Set([1092,1128,1396,1751,1753,1755,2008,2012,2037,2099]);

        // render a batch of items
        function renderBatch(start, batchSize, query){
          const frag = document.createDocumentFragment();
          let rendered = 0;
          for (let i = start; i < Math.min(TOTAL+1, start + batchSize); i++){
            const subj = makeSubject(i);
            if (!matches(subj, query)) continue;
            const item = document.createElement('div');
            item.style.padding = '8px 6px';
            item.style.borderBottom = '1px solid #f1f5f9';
            // If this subject has its own page, render as a link
              if (CLICKABLE_IDS.has(subj.id)){
              const a = document.createElement('a');
              a.href = `subjects/subject-${subj.id}.html`;
              a.textContent = subj.name + ' →';
              a.style.color = 'var(--brand-navy)';
              a.style.textDecoration = 'none';
              a.style.fontWeight = '600';
              item.appendChild(a);
            } else {
              item.textContent = `${subj.name}`;
            }
            frag.appendChild(item);
            rendered++;
          }
          container.appendChild(frag);
          return rendered;
        }

        // chunked rendering loop
        function renderAll(query){
          container.innerHTML = '';
          countEl.textContent = 'Rendering list...';
          const BATCH = 200; // render 200 items per animation frame
          let start = 1;
          let totalRendered = 0;

          function step(){
            const r = renderBatch(start, BATCH, query);
            totalRendered += r;
            start += BATCH;
            // update count
            countEl.textContent = `${totalRendered} subject${totalRendered===1? '':'s'} shown`;
            if (start <= TOTAL){
              // schedule next chunk
              if (window.requestIdleCallback) requestIdleCallback(step, {timeout:50}); else setTimeout(step, 16);
            } else {
              // finished, show final count
              countEl.textContent = `${totalRendered} subject${totalRendered===1? '':'s'} shown`;
            }
          }
          step();
        }

        // debounce
        function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t = setTimeout(()=>fn.apply(this, arguments), ms); }}

        // initial render
        renderAll('');

        // handlers
        searchEl.addEventListener('input', debounce((e) => { renderAll(e.target.value); }, 250));
        clearBtn.addEventListener('click', () => { searchEl.value=''; renderAll(''); searchEl.focus(); });
        goBtn.addEventListener('click', () => {
          const v = Number(jumpEl.value);
          if (!v || v < 1 || v > TOTAL){ alert('Enter a subject number between 1 and ' + TOTAL); return; }
          // scroll to approximate position: calculate percentage
          const ratio = (v - 1) / (TOTAL - 1);
          container.scrollTop = Math.floor((container.scrollHeight - container.clientHeight) * ratio);
        });
      }

      document.getElementById('chimaraLogout').addEventListener('click', () => {
        localStorage.removeItem('chimara_access');
        location.href = 'chimara.html';
      });
    </script>
  </body>
</html>
